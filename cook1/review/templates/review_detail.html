{% extends "base.html" %}
{% block content %}
    <h2>{{ review.selected_menu.menu_name }}</h2>
    <p><strong>ì‘ì„±ì:</strong> 
        {{ review.user.nickname }} (
        {{ review.user.username|slice:":3" }}
        {% if review.user.username|length > 3 %}
            {% with remaining=review.user.username|length|add:"-3" %}
                {% for _ in "x"|ljust:remaining %}*{% endfor %}
            {% endwith %}
        {% endif %}
        )
    </p>

    <p><strong>ë³„ì :</strong> <span class="star-display">â˜…</span> {{ review.rating }}</p>
    <p><strong>ì¡°íšŒìˆ˜:</strong> {{ review.views }}</p>
    <p>{{ review.review_text }}</p>

    <!-- ì²« ë²ˆì§¸ ì‚¬ì§„ + ì¶”ê°€ ì‚¬ì§„ ê°œìˆ˜ í‘œì‹œ -->
    {% with review.reviewimages_set.all as images %}
        {% if images %}
            <div class="review-images">
                <div class="main-image">
                    <img src="{{ images.0.image_url }}" alt="ë¦¬ë·° ì´ë¯¸ì§€" class="review-image">
                    {% if images|length > 1 %}
                        <span class="image-count" onclick="openGallery()">+{{ images|length|add:"-1" }}</span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <!-- ê°¤ëŸ¬ë¦¬ ëª¨ë‹¬ -->
    <div id="image-gallery" class="gallery-modal">
        <span class="close" onclick="closeGallery()">&times;</span>
        <div class="gallery-wrapper">
            {% for image in review.reviewimages_set.all %}
                <img src="{{ image.image_url }}" class="gallery-image" onclick="openFullScreen({{ forloop.counter0 }})">
            {% endfor %}
        </div>
    </div>

    <!-- ì¢‹ì•„ìš” ë²„íŠ¼ -->
    <button id="like-btn" onclick="toggleLike()">
        ğŸ‘ ì¢‹ì•„ìš” (<span id="like-count">{{ ReviewComments.objects.filter(review=review, like_type='review_like').count }}</span>)
    </button>

    <!-- ëŒ“ê¸€ ì…ë ¥ í¼ -->
    <h3>ëŒ“ê¸€</h3>
    <form method="POST" action="{% url 'add_comment' review.pk %}">
        {% csrf_token %}
        <textarea name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
        <button type="submit">ëŒ“ê¸€ ì‘ì„±</button>
    </form>
    
    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <ul id="comment-list">
        {% for comment in review.reviewcomments_set.all %}
            <li id="comment-{{ comment.id }}">
                <strong>{{ comment.user.nickname }}</strong>: {{ comment.comment_text }}
    
                {% if request.user == comment.user %}  
                    <form method="POST" action="{% url 'delete_comment' comment.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">âŒ</button>
                    </form>
                {% endif %}
            
                <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ -->
                <form method="POST" action="{% url 'add_reply' comment.id %}" style="margin-left: 20px; margin-top: 5px;">
                    {% csrf_token %}
                    <textarea name="content" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                    <button type="submit">ë‹µê¸€ ì‘ì„±</button>
                </form>

                <!-- ëŒ€ëŒ“ê¸€ ëª©ë¡ -->
                <ul style="margin-left: 40px;">
                    {% for reply in comment.reviewcomments_set.all %}
                        <li id="reply-{{ reply.id }}">
                            <strong>{{ reply.user.nickname }}</strong>: {{ reply.comment_text }}
                            
                            {% if request.user == reply.user %}
                                <form method="POST" action="{% url 'delete_reply' reply.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit">âŒ</button>
                                </form>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </li>
        {% endfor %}
    </ul>
{% endblock %}
